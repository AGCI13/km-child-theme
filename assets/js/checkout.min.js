jQuery(document).ready(function(e){const t=document.querySelector(".woocommerce-billing-actions"),i=document.querySelector(".woocommerce-billing-fields"),o=document.querySelector(".shipping_address"),c=document.querySelectorAll(".step-shipping"),n=document.querySelector("#custom_paiement_btn");c.forEach(e=>e.classList.add("active")),e(".step-cart").on("click",function(){window.location.href=window.location.origin+"/panier/"}),e(document.body).on("updated_checkout",function(){l(".shopengine-checkout-shipping-methods"),setTimeout(function(){showCouponForm(),r(),L(),f(),h(),d(),e(document.body).on("change","#shipping_postcode",function(){a().then(()=>{e("body").trigger("update_checkout")}).catch(e=>{})}),e("input, select").on("input change",function(t){q(e(this).closest(".validate-required, .validate-phone, .validate-email"))}),e("#custom_paiement_btn").prop("disabled",!1).removeClass("disabled")},200)}),e(document.body).on("update_checkout",()=>{e("#custom_paiement_btn").prop("disabled",!0).addClass("disabled"),s(".shopengine-checkout-shipping-methods")});const s=t=>{const i='<div class="km-spinner"></div>';e(t).append(i)},l=t=>{e(t).find(".km-spinner").remove()},a=()=>new Promise((e,t)=>{const i=document.querySelector("#shipping_country");if(!i)return void e();const o=document.querySelector("#shipping_postcode");if(!o)return void e();const c=i.value.trim(),n=o.value.trim(),s=n+"-"+c,l=getCookie("zip_code").trim(),a=document.getElementById("shipping_postcode"),r=document.querySelector("#nonce_postcode");if(!r||s===l)return void e();const d={zip:n,country:c,nonce_postcode:r.value};kmAjaxCall("postcode_submission_handler",d).then(t=>{if(t.success)setCookie("zip_code",s,30),setCookie("shipping_zone",t.data,30),document.querySelector(".modal_pc_open_btn").textContent=n;else if(t.data.message&&a){errorMessage="string"==typeof t.data.message?t.data.message:"Une erreur est survenue.";const e=a.closest(".form-row").querySelector(".km-validation-info");e?e.textContent=errorMessage:a.closest(".form-row").insertAdjacentHTML("beforeend",`<span class="km-validation-info">${errorMessage}</span>`)}e()}).catch(e=>{t(e)})}),r=()=>{const e=document.querySelector(".woocommerce-shipping-totals.shipping");let c=e.querySelectorAll(".woocommerce-shipping-methods"),n=e.querySelectorAll(".km-shipping-option"),s=e.querySelectorAll('input[type="radio"].shipping_method');c.forEach(e=>{e.addEventListener("click",()=>p(e,n,s,t,i,o))}),n.forEach(e=>{e.addEventListener("click",()=>m(e,n))})},d=()=>{const e=document.querySelector(".woocommerce-shipping-methods.selected");e&&e.id&&("shipping-method-shipping"===e.id&&(g("billing",!1),y(!1)),"shipping-method-drive"===e.id&&(g("billing",!0),g("shipping",!1),y(!0),h(e.id),_()))},u=()=>{const e=document.querySelector("#shipping_first_name"),t=document.querySelector("#billing_first_name"),i=document.querySelector("#shipping_last_name"),o=document.querySelector("#billing_last_name"),c=document.querySelector("#shipping_address_1"),n=document.querySelector("#billing_address_1"),s=document.querySelector("#shipping_address_2"),l=document.querySelector("#billing_address_2"),a=document.querySelector("#shipping_city"),r=document.querySelector("#billing_city"),d=document.querySelector("#shipping_postcode"),u=document.querySelector("#billing_postcode"),p=document.querySelector("#shipping_country"),m=document.querySelector("#billing_country"),v=document.querySelector(".woocommerce-shipping-methods.selected");v&&v.id&&("shipping-method-drive"===v.id?(t&&e&&""===e.value&&(e.value=t.value),o&&i&&""===i.value&&(i.value=o.value),n&&c&&""===c.value&&(c.value=n.value),l&&s&&""===s.value&&(s.value=l.value),r&&a&&""===a.value&&(a.value=r.value)):(e&&t&&""===t.value&&(t.value=e.value),i&&o&&""===o.value&&(o.value=i.value),c&&n&&""===n.value&&(n.value=c.value),s&&l&&""===l.value&&(l.value=s.value),a&&r&&""===r.value&&(r.value=a.value),d&&u&&""===u.value&&(u.value=d.value),p&&m&&""===m.value&&(m.value=p.value)))},p=(e,t,i,o,c,n)=>{if(e.classList.contains("selected"))return;const s=e.id;localStorage.setItem("selectedShipping",s),document.querySelectorAll(".woocommerce-shipping-methods.selected").forEach(e=>e.classList.remove("selected")),e.classList.add("selected"),"shipping-method-shipping"===s&&v(),"shipping-method-drive"===s&&document.querySelector("input#shipping_method_0_drive").click(),h(s)},m=(e,t)=>{if(e.classList.contains("selected"))return;t.forEach(e=>e.classList.remove("selected")),e.classList.add("selected");const i=e.querySelector("input");localStorage.setItem("selectedShippingOption",i.value),i.click()},v=()=>{const e=localStorage.getItem("selectedShippingOption");if(e){const t=document.querySelector(`input[value="${e}"]`);if(t){const e=t.closest(".km-shipping-option");e&&e.click()}}else{const e=document.querySelector(".km-shipping-option");e&&e.click()}},h=e=>{const i=document.querySelector(".bool-action.false"),c=document.querySelector(".bool-action.true"),n=document.querySelector(".woocommerce-billing-fields__field-wrapper");"shipping-method-shipping"===e&&(t.style.display="block",n.classList.remove("active"),o.style.display="block"),"shipping-method-drive"===e&&(t.style.display="none",n.classList.add("active"),o.style.display="none"),c.addEventListener("click",function(){this.classList.add("selected"),i.classList.remove("selected"),n.classList.remove("active"),g("billing",!1)}),i.addEventListener("click",function(){this.classList.add("selected"),c.classList.remove("selected"),n.classList.add("active"),g("billing",!0)})},g=(e,t)=>{const i=["#"+e+"_first_name_field","#"+e+"_last_name_field","#"+e+"_address_1_field","#"+e+"_city_field","#"+e+"_postcode_field","#"+e+"_country_field","#"+e+"_phone_field","#"+e+"_email_field"];i.forEach(i=>{const o=document.querySelector(i);if(!o)return;const c=o.querySelector("input, select");c&&(t?o.classList.add("shopengine-checkout-form-"+e,"validate-required"):o.classList.remove("shopengine-checkout-form-"+e,"validate-required"),c.required=t)})},y=e=>{const t=document.querySelector("#shipping-method-drive");if(!t)return;const i=t.querySelectorAll(".must-validate");i.forEach(t=>{e?t.classList.add("validate-required"):t.classList.remove("validate-required")})},_=()=>{let t=document.querySelectorAll(".drive-datetimepicker");t.forEach(function(t){const i=document.querySelectorAll(".drive-datepicker-day .day"),o=document.querySelectorAll(".drive-datepicker-time .slot"),c=document.querySelector(".woocommerce-checkout-review-order-table .shipping-cost"),n=localStorage.getItem("driveDate"),s=localStorage.getItem("driveTime");let l=n,a=s;const r=(e,t)=>{e.forEach(e=>{e.classList.remove("active")}),t.classList.add("active")},d=()=>{if(!l&&!a)return;const e=l.split("-"),t=e[2]+"/"+e[1]+"/"+e[0];c.innerHTML="le "+t+" à "+a},u=o=>{r(i,o);const c=o.dataset.date,n=t.querySelector(".drive_date");n.value=c,l=c,t.querySelector("#drive-date-wrapper").classList.add("woocommerce-validated"),localStorage.setItem("driveDate",c),d(),o.innerText.includes("samedi")?(document.querySelector(".time-slot.afternoon").classList.add("disabled"),document.querySelectorAll(".time-slot.afternoon .slot").forEach(e=>{e.classList.remove("active")})):document.querySelector(".time-slot.afternoon").classList.remove("disabled"),q(e('[name="drive_date"]'))},p=i=>{r(o,i);const c=i.dataset.time,n=t.querySelector(".drive_time");n.value=c,a=c,t.querySelector("#drive-time-wrapper").classList.add("woocommerce-validated"),localStorage.setItem("driveTime",c),d(),q(e('[name="drive_time"]'))};i.forEach(e=>{e.addEventListener("click",()=>{u(e)})}),o.forEach(e=>{e.addEventListener("click",()=>{p(e)})}),e("form.checkout").on("checkout_place_order",function(){var t=e(".drive_date").val(),i=e(".drive_time").val();return!!t&&!!i});let m=1;t.querySelector(".load-more-days").addEventListener("click",function(e){let i=20*m;handleLoading(e,!0),kmAjaxCall("get_drive_available_days",{offset:i}).then(i=>{i.success&&(t.querySelector(".day-list").innerHTML+=i.data,m++,_()),handleLoading(e,!1)}).catch(e=>{console.error("Erreur lors de la récupération des jours supplémentaires:",e)})});const v=()=>{if(n){const e=t.querySelector('.drive-datepicker-day .day[data-date="'+n+'"]');e&&e.click(),e.innerText.includes("samedi")&&document.querySelector(".time-slot.afternoon").classList.add("disabled")}if(s){const e=t.querySelector('.drive-datepicker-time .slot[data-time="'+s+'"]');e&&e.click()}};v(),d()})},f=()=>{const e=document.querySelectorAll(".km-multistep-navbar"),t=document.querySelector(".shopengine-multistep-navbar"),i=t.querySelector('.shopengine-multistep-button[data-item="0"]'),o=t.querySelector('.shopengine-multistep-button[data-item="1"]'),c=document.querySelector("#back-to-shipping");e.forEach(e=>{let t=e.querySelector(".step-shipping"),c=e.querySelector(".step-payment");t.addEventListener("click",()=>{i.click(),i.parentElement.classList.contains("active")&&(t.classList.add("active"),c.classList.remove("active"))}),c.addEventListener("click",()=>{o.click(),o.parentElement.classList.contains("active")&&(c.classList.add("active"),t.classList.remove("active"))}),n.addEventListener("click",()=>{k(),isValid=q();const e=document.querySelector("#checkout-nav");e&&document.querySelector("#checkout-nav").scrollIntoView({behavior:"smooth",block:"nearest",inline:"start"}),isValid&&(S(),u(),c.click())})}),c&&c.addEventListener("click",()=>{i.click(),i.parentElement.classList.contains("active")&&(stepShipping.classList.add("active"),stepPayment.classList.remove("active"))})},S=()=>{const e=document.querySelector(".km-shipping-option.selected");if(e){if(shipping_price=e.getAttribute("data-shipping-price"),shipping_sku=e.getAttribute("data-shipping-sku"),shipping_tax=e.getAttribute("data-shipping-tax"),shipping_price){const e=document.getElementById("km_shipping_price");e&&(e.value=shipping_price)}if(shipping_sku){const e=document.getElementById("km_shipping_sku");e&&(e.value=shipping_sku)}if(shipping_tax){const e=document.getElementById("km_shipping_tax");e&&(e.value=shipping_tax)}}},k=()=>{localStorage.removeItem("driveDate"),localStorage.removeItem("driveTime"),localStorage.removeItem("selectedShipping"),localStorage.removeItem("selectedShippingOption")},q=(t=null)=>{const i=e("#km-checkout-errors"),o=e(".shopengine-active-step");let c=!0,n={};i.empty(),e(".km-validation-info").remove();const s=()=>{let e="<ul>";Object.values(n).forEach(t=>{e+=`<li>${t}</li>`}),e+="</ul>",i.html(e),0===Object.keys(n).length?i.hide():i.show()},l=t||o.find(".validate-required, .validate-phone, .validate-email");return l.each(function(){const t=e(this).closest(".validate-required, .validate-phone, .validate-email"),i=t.find("input, select, textarea"),o=t.find("label").text().replace("*","").trim(),l=t.attr("id")||i.attr("name"),a=`Le champ "${o}" n'est pas correctement rempli.`;"shipping_postcode"===i.attr("id")?(5!==i.val().length&&(c=!1,t.append('<span class="km-validation-info">Le code postal doit contenir 5 chiffres</span>'),n[l]=a),i.on("input change",function(){t.find(".km-validation-info").remove(),delete n[l],s()})):(i.is(":checkbox")&&!i.is(":checked")||""===i.val())&&(c=!1,t.append('<span class="km-validation-info">Ce champ est requis</span>'),n[l]=a,i.on("input change",function(){t.find(".km-validation-info").remove(),delete n[l],s()}))}),s(),c},L=()=>{const e=document.querySelector("form.checkout");e.addEventListener("keydown",function(e){"Enter"===e.key&&e.preventDefault()})}});